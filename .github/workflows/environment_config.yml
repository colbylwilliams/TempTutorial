name: Environment Config

on:
  workflow_call:
    # Map the workflow outputs to job outputs
    outputs:
      name:
        description: 'The name of the environment'
        value: ${{ jobs.env_config.outputs.name }}
      type:
        description: 'The type of the environment'
        value: ${{ jobs.env_config.outputs.type }}

env:
  # format: ci-[branch|pr]-[branch name|pr number]-suffexe
  ENVIRONMENT_NAME: ci-${{ github.event_name == 'pull_request' && 'pr' || 'branch' }}-${{ github.event_name == 'pull_request' && github.event.number || github.event_name == 'push' && github.ref_name || github.event.ref }}-${{ github.event.repository.id }}

  # branch/Pull request | Environment Type
  # --------------------------------------
  # feature branches    | Dev
  # feature -> main PR  | Test
  # main branch         | Prod
  ENVIRONMENT_TYPE: ${{ github.event_name == 'push' && (github.event.ref == 'refs/heads/main' && 'Prod' || 'Dev') || github.event_name == 'pull_request' && (github.event.pull_request.base.ref == 'main' && 'Test') || 'Dev' }}

jobs:
  env_config:
    name: Config
    runs-on: ubuntu-latest
    # Map the job outputs to step outputs
    outputs:
      name: ${{ steps.get_config.outputs.name }}
      type: ${{ steps.get_config.outputs.type }}
    environment: ${{ env.ENVIRONMENT_TYPE }}

    steps:
      - name: Validate Environment Secrets
        shell: python
        run: |
          import os

          if (environment_type := os.getenv('ENVIRONMENT_TYPE')) is None:
              print('::error title=Environment not set: ENVIRONMENT_TYPE::Please set the environment variable ENVIRONMENT_TYPE.')
              exit(1)

          if environment_type not in ['Dev', 'Test', 'Prod']:
              print('::error title=Invalid environment type::Please set the environment to one of Dev, Test, or Prod.')
              exit(1)

          required_secrets = {
              'AZURE_CLIENT_ID': 'the app id (or client id) of your service principal'
          }

          secrets = ${{ toJson( secrets ) }}

          for k, v in required_secrets.items():
              if k not in secrets:
                  print(f'::error title=Missing required environment secret: {k}::Please create a new secret for the {environment_type} environment named {k} with {v}. https://docs.github.com/en/actions/security-guides/encrypted-secrets#creating-encrypted-secrets-for-an-environment')
                  exit(1)

      - name: Validate Repository Variables
        shell: python
        run: |
          required_vars = {
              'AZURE_TENANT_ID': 'your Azure tenant Id (GUID)',
              'AZURE_SUBSCRIPTION_ID': 'your Azure subscription Id (GUID)',
              'AZURE_DEVCENTER': 'the name of your dev center',
              'AZURE_PROJECT': 'the name of your dev center project'
          }

          variables = ${{ toJson( vars ) }}

          for k, v in required_vars.items():
              if k not in variables:
                  print(f'::error title=Missing required repository variable: {k}::Please create a new repository variable named {k} with {v}. https://docs.github.com/en/actions/learn-github-actions/variables#creating-configuration-variables-for-a-repository')
                  exit(1)

      - run: echo "- **Environment Name**  $ENVIRONMENT_NAME" >> $GITHUB_STEP_SUMMARY
      - run: echo "- **Environment Type**  $ENVIRONMENT_TYPE" >> $GITHUB_STEP_SUMMARY

      - id: get_config
        name: Set Outputs
        run: |
          "name=ENVIRONMENT_NAME" >> $GITHUB_OUTPUT
          "type=ENVIRONMENT_TYPE" >> $GITHUB_OUTPUT

      # - name: Ensure GitHub Environments
      #   uses: actions/github-script@v6
      #   with:
      #     script: |
      #       const environments_result = await github.rest.repos.getAllEnvironments({
      #         owner: context.repo.owner,
      #         repo: context.repo.repo,
      #       });

      #       const environments = environments_result.data.environments;

      #       const names = ['Dev', 'Test', 'Pre-Prod', 'Prod'];

      #       for (let i = 0; i < names.length; i++) {
      #         const name = names[i];
      #         const exists = environments.some(e => e.name === name);
      #         if (!exists) {
      #           core.setFailed(`A GitHub environment named '${name}' does not exist. Create an environment nammed '${name}' with a secret named 'AZURE_CREDENTIALS'`);
      #         }
      #       }
